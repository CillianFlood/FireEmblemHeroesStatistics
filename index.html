<script>
document.addEventListener("DOMContentLoaded", () => {

const API_URL = "https://script.google.com/macros/s/AKfycby2SIa1xkldeimH7OrkltvK9BoPE07PELtGEriB5gPZ8GSzu42ErrvZo3M73S5k8aBycg/exec";

const search = document.getElementById("search");
const tableHead = document.querySelector("#dataTable thead");
const tableBody = document.querySelector("#dataTable tbody");
const checkboxes = document.querySelectorAll("#filters input");

let headers = [];
let rows = [];
let sortColumn = null;
let sortAsc = true;

/* FILTERS */

checkboxes.forEach(cb => {
  cb.addEventListener("change", applyFilters);
});

search.addEventListener("input", applyFilters);

function applyFilters() {
  const selected = Array.from(checkboxes)
    .filter(cb => cb.checked)
    .map(cb => cb.value);

  renderTable(selected);
}

<div class="toolbar">
<input id="search" type="text" placeholder="Search by character name..." />
</div>
/* RENDER */

function renderTable(selectedAllegiances = ["Player","Enemy","Ally"]) {

  const filter = search.value || "";
  const f = filter.toLowerCase();

  tableHead.innerHTML = "";
  tableBody.innerHTML = "";

  const allegianceIndex = headers.indexOf("Allegiance");
  const characterIndex = headers.indexOf("Character");
  const mugIndex = headers.indexOf("Mug");
  const moveTypeIndex = headers.indexOf("Move Type");

  const headerRow = document.createElement("tr");

  headers.forEach((h, index) => {
    const th = document.createElement("th");
    th.textContent = h;

    if (h !== "Allegiance") {
      th.style.cursor = "pointer";
      th.addEventListener("click", () => {
        if (sortColumn === index) {
          sortAsc = !sortAsc;
        } else {
          sortColumn = index;
          sortAsc = true;
        }

        sortRows();
        applyFilters();
      });
    }

    headerRow.appendChild(th);
  });

  tableHead.appendChild(headerRow);

  rows
    .filter(r => {
      if (allegianceIndex !== -1 &&
          !selectedAllegiances.includes(r[allegianceIndex])) {
        return false;
      }

      if (!filter) return true;

      return (
        characterIndex !== -1 &&
        r[characterIndex] &&
        r[characterIndex].toString().toLowerCase().includes(f)
      );
    })
    .forEach(r => {

      const tr = document.createElement("tr");

      r.forEach((cell, i) => {
        const td = document.createElement("td");

        if (i === mugIndex && cell) {
          const img = document.createElement("img");
          img.src = cell;
          img.className = "mug";
          td.appendChild(img);
        }
        else if (i === moveTypeIndex && cell) {
          const img = document.createElement("img");
          img.src = cell;
          img.className = "moveType";
          td.appendChild(img);
        }
        else {
          if (!isNaN(cell) && cell !== "") {
            td.textContent = Number(
              cell.toString().replace(/,/g,"")
            ).toLocaleString(undefined, {
              maximumFractionDigits: 2
            });
          } else {
            td.textContent = cell;
          }
        }

        tr.appendChild(td);
      });

      tableBody.appendChild(tr);
    });
}

/* SORTING */

function sortRows() {
  if (sortColumn === null) return;

  rows.sort((a, b) => {

    const cleanA = a[sortColumn]?.toString().replace(/,/g,"") || "";
    const cleanB = b[sortColumn]?.toString().replace(/,/g,"") || "";

    const numA = parseFloat(cleanA);
    const numB = parseFloat(cleanB);

    if (!isNaN(numA) && !isNaN(numB)) {
      return sortAsc ? numA - numB : numB - numA;
    }

    const valA = cleanA.toLowerCase();
    const valB = cleanB.toLowerCase();

    if (valA < valB) return sortAsc ? -1 : 1;
    if (valA > valB) return sortAsc ? 1 : -1;
    return 0;
  });
}

/* FETCH */

fetch(API_URL + "?endpoint=forwebsite")
  .then(r => r.json())
  .then(data => {
    headers = data.headers;
    rows = data.rows;
    applyFilters();
  })
  .catch(err => console.error("FETCH FAILED:", err));

});
</script>
